# Анонимный телеграм‑бот для хороших людей (Шляпужников)

Этот проект представляет собой телеграм‑бота, который помогает заявителям анонимно обращаться к правозащитникам. Бот выступает посредником между пользователями и закрытой группой администраторов: сообщения заявителя пересылаются в группу, а ответы администраторов возвращаются пользователю без раскрытия их личности. В основе бота лежит библиотека **aiogram**, а для шифрования данных используется **cryptography** (Fernet). Реализация соответствует техническому заданию и содержит модули для шифрования сообщений, управления заявками, удаления метаданных из изображений и интеграции с API VirusTotal для проверки вложений.

## Возможности

- **Анонимность**: пользователи получают ответы без раскрытия ID администратора, а администраторы видят только зашифрованные идентификаторы заявителей.
- **Уникальные заявки**: для каждой заявки создаётся уникальный идентификатор, который используется для поиска и отслеживания статуса.
- **Шифрование данных**: текст сообщений и файлов перед записью в базу данных шифруется симметричным алгоритмом Fernet. Ключ хранится в переменной окружения.
- **Обработка файлов**: изображения очищаются от EXIF‑метаданных, документы могут быть переупакованы (в текущей версии реализована очистка изображений).
- **Проверка вложений и ссылок**: при наличии ключа API VirusTotal бот отправляет файлы и ссылки на анализ и блокирует опасные вложения.
- **Rate limiting и верификация**: новые пользователи проходят квиз‑проверку, а частота отправки сообщений ограничена (по умолчанию 100 сообщений в час).
- **Ролевая модель**: настроены роли (owner, admin, moderator, volunteer) с различными правами доступа.

## Требования

- Python 3.9 или выше.
- Доступ к API Telegram (BotFather) для получения токена бота.
- Учётная запись на VirusTotal (опционально) для получения ключа API.
- Linux/Unix сервер или рабочий компьютер для запуска бота (на Windows также возможно, но команды могут отличаться).

## Установка

1. **Клонируйте репозиторий**:
   ```bash
   git clone https://github.com/<ваш‑аккаунт>/<имя‑репозитория>.git
   cd <имя‑репозитория>
   ```

2. **Создайте и активируйте виртуальное окружение** (рекомендуется для изоляции зависимостей):
   ```bash
   python3 -m venv venv
   source venv/bin/activate
   ```

3. **Установите зависимости** из файла `requirements.txt`:
   ```bash
   pip install -r requirements.txt
   ```

4. **Подготовьте базу данных**. Бот автоматически создаст SQLite‑файл и таблицы при первом запуске, но убедитесь, что каталог для БД существует.

## Настройка окружения

Для корректной работы бота требуется указать несколько переменных окружения. Их можно определить в файле `.env` (если вы используете [dotenv](https://pypi.org/project/python-dotenv/) или системные скрипты) или экспортировать перед запуском процесса. Обязательные переменные:

- `BOT_TOKEN` — токен, полученный у [BotFather](https://t.me/BotFather) при создании бота.
- `ADMIN_GROUP_ID` — числовой идентификатор приватной группы Telegram, куда будут пересылаться все сообщения заявителей. Обычно начинается с `-100`.
- `ENCRYPTION_KEY` — ключ для шифрования данных в формате URL‑safe base64. Можно сгенерировать с помощью скрипта:
  ```python
  from cryptography.fernet import Fernet
  print(Fernet.generate_key().decode())
  ```
- `DB_PATH` — путь к файлу базы данных SQLite (например, `data/database.db`).

Дополнительные переменные:

- `VT_API_KEY` — ключ API VirusTotal. Если задан, бот будет отправлять файлы и ссылки на проверку. Без этого ключа проверка отключена.
- `RATE_LIMIT_COUNT` и `RATE_LIMIT_INTERVAL` — параметры ограничения частоты сообщений (по умолчанию 100 сообщений в час). Изменяются в коде или через переменные окружения.

Пример `.env` файла:
```env
BOT_TOKEN=123456789:ABCDEF...Z
ADMIN_GROUP_ID=-1001234567890
ENCRYPTION_KEY=KhT5U2YqY... (32‑байтовая строка)
DB_PATH=data/database.db
VT_API_KEY=your_virustotal_api_key
```

## Запуск

1. Убедитесь, что бот приглашён в приватную группу администраторов и имеет права отправлять сообщения.
2. Экспортируйте переменные окружения или загрузите `.env`.
3. Запустите файл `bot.py`:
   ```bash
   python bot.py
   ```
   При первом запуске будут созданы база данных и необходимые таблицы.

### Запуск как службы (рекомендация)

Для непрерывной работы на сервере рекомендуется запустить бота как системную службу (например, используя **systemd**). Пример юнита `/etc/systemd/system/anonbot.service`:

```
[Unit]
Description=Telegram Anonymous Bot
After=network.target

[Service]
User=youruser
Group=yourgroup
WorkingDirectory=/path/to/your/repo
EnvironmentFile=/path/to/your/repo/.env
ExecStart=/path/to/your/repo/venv/bin/python bot.py
Restart=always

[Install]
WantedBy=multi-user.target
```

После создания файла выполните:

```bash
sudo systemctl daemon-reload
sudo systemctl enable anonbot
sudo systemctl start anonbot
```

## Краткое описание файлов

- `bot.py` — основной код бота. Содержит реализацию всех функций: обработку команд и сообщений, шифрование, хранение данных, работу с VirusTotal и очистку метаданных изображений.
- `requirements.txt` — список используемых библиотек Python.

## Советы по безопасной эксплуатации

1. **Храните ключ шифрования в надёжном месте**: не коммитите его в репозиторий и регулярно производите ротацию.
2. **Используйте прокси или VPN** для администраторского аккаунта, чтобы скрыть IP‑адреса при работе с заявителями.
3. **Проверяйте обновления зависимостей** и своевременно обновляйте библиотеку aiogram и другие компоненты.
4. **Настройте двухфакторную аутентификацию** для администраторов: в коде предусмотрены проверки пароля и OTP, но рекомендуем интегрировать полноценный сервис одноразовых паролей.
5. **Проводите аудит логов** и регулярно создавайте резервные копии базы данных.

## Обратная связь

Если у вас возникли вопросы или предложения по улучшению бота, создавайте задачи в разделе Issues этого репозитория. Будем рады вашему участию!
